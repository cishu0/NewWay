<!DOCTYPE html>
<html>
<head>
    <title>NewWay混淆器</title>
    <style>
        /* 设置整个body的文本居中 */
        body {
            text-align: center; /* 水平居中文本 */
            margin-top: 50px; /* 添加顶部间距 */
        background-image: url('background.jpg'); /* 设置背景图片 */
        background-size: cover; /* 背景图片覆盖整个页面 */
        background-position: center; /* 背景图片居中显示 */
        }
       /* 设置表单元素的默认显示为块级元素，并确保宽度自动调整 */
    input[type='radio'], label {
        display: inline-block; /* 保持混淆选项按钮内联显示 */
        width: 200px; /* 统一宽度 */
        background-color: rgba(255, 255, 255, 0.8); /* 添加半透明白色背景以增强可读性 */
        padding: 10px; /* 增加内边距 */
        border-radius: 5px; /* 圆角边框 */
        text-align: center; /* 文本居中显示 */
        margin: 10px 5px; /* 小幅度间隔调整 */
    }
    /* 单独设置上传按钮为块级，确保其在新的一行显示 */
    button {
        display: block; /* 使上传按钮单独一行 */
        margin: 20px auto; /* 增加较大的上下间距 */
        width: 200px; /* 控制按钮宽度 */
        padding: 10px; /* 内边距 */
        border-radius: 5px; /* 圆角边框 */
        background-color: #4CAF50; /* 设定一个明显的颜色 */
        color: white; /* 字体颜色 */
        cursor: pointer; /* 指针变为手形 */
    }
    /* 调整文件输入元素和进度条 */
    input[type='file'], progress {
        display: block;
        width: 80%; /* 控制宽度 */
        margin: 20px auto; /* 调整间距 */
        padding: 15px; /* 增加填充，使按钮更大 */
        font-size: 16px; /* 增大字体，改善可读性 */
        cursor: pointer; /* 明确显示这是一个可点击的按钮 */
        background-color: #f8f9fa; /* 轻色背景 */
        border: 2px solid #ddd; /* 细边框样式 */
        border-radius: 5px; /* 圆角边框 */
    }
    /* 加粗进度条 */
    progress {
        display: block;
        width: 80%; /* 控制宽度 */
        height: 30px; /* 增加进度条的高度，使其更粗 */
        margin: 20px auto; /* 保持居中和间距 */
        background-color: #eee; /* 设定背景色 */
        color: #4CAF50; /* 设定前景色，某些浏览器支持 */
    }
    h1 {
        font-size: 60px; /* 调整为更大的字号 */
        color: #ffffff; /* 可以选择一个适合背景的字体颜色 */
        /*text-shadow: 2px 2px 4px #000000; 增加文字阴影以提高可读性 */
    }

    p {
        font-size: 45px; /* 增加段落文字的字号 */
        color: #ffffff; /* 同样可以调整颜色 */
        /*text-shadow: 1px 1px 2px #000000; 文字阴影 */
    }
    </style>
</head>
<body>
    <h1>NewWay在线混淆</h1>
    <p>请上传大小不超过1MB的.c，.cc，.cpp源文件</p>
    <input type="file" id="fileInput"><br>

    <label><input type="radio" name="option" value="-fla">控制流平坦化</label>
    <label><input type="radio" name="option" value="-bcf">虚假控制流</label>
    <label><input type="radio" name="option" value="-sub">指令替换</label>
    <label><input type="radio" name="option" value="-sobf">字符串加密</label>
    <label><input type="radio" name="option" value="-vrobf">变量轮转</label>

    <button onclick="uploadFile()">上传</button>
    <progress id="uploadProgress" value="0" max="100"></progress> <!-- 进度条 -->
    <div id="uploadStatus"></div> <!-- 上传状态显示 -->

    <script>
        function uploadFile() {
            const fileInput = document.getElementById('fileInput');

            // 检查文件是否已选择
            if (fileInput.files.length === 0) {
                alert('请先选择一个文件。');
                return;
            }

            const file = fileInput.files[0];
            if (file.size > 1024 * 1024) {
                alert('文件大小超过1MB，请上传较小的文件。');
                return;
            }

            // 获取选中的混淆选项
            const options = document.getElementsByName('option');
            let selectedOption = null;
            for (const option of options) {
                if (option.checked) {
                    selectedOption = option.value;
                    break;
                }
            }

            // 检查是否选择了一个混淆选项
            if (!selectedOption) {
                alert('请选择一个混淆选项。');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('option', selectedOption);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'http://192.168.10.138:5000/upload', true);

            // 上传进度显示
            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percentage = (event.loaded / event.total) * 100;
                    document.getElementById('uploadProgress').value = percentage;
                }
            };

            // 处理上传完成事件
            xhr.onload = function() {
	//成功
                if (xhr.status == 200) {
	    const fileName = file.name;
       	    const extensionIndex = fileName.lastIndexOf('.');
        	    const baseName = fileName.substring(0, extensionIndex);
	    const newFileName = `${baseName}_${selectedOption}`;

                    const url = window.URL.createObjectURL(xhr.response);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = newFileName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.getElementById('uploadStatus').innerText = '上传成功！';
                } else {
                    // 解析服务器返回的JSON响应以获取具体的错误消息
                    xhr.response.text().then(text => {
                        const response = JSON.parse(text);
                        document.getElementById('uploadStatus').innerText = '上传失败：' + response.message;
                    }).catch(() => {
                        // 如果无法解析JSON，回退到使用statusText
                        document.getElementById('uploadStatus').innerText = '上传失败：' + xhr.statusText;
                    });
                }
            };

            // 设置响应类型为blob
            xhr.responseType = 'blob';
            xhr.send(formData);
        }
    </script>
</body>
</html>
